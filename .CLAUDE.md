# Claude Development Guidelines for Unfurl Service - Core Document

## ğŸ§  Context Management

**For long conversations, review this document:**
- Before starting any new task
- When switching between components (scrapers/handlers/infrastructure)
- If you feel context drifting (~3000 tokens)
- Before any git operations or deployments

## ğŸš¨ CRITICAL RULES - NEVER VIOLATE

1. **ğŸ” NEVER commit secrets** - Use AWS Secrets Manager for all credentials
2. **ğŸ“ NEVER use `git add .`** - Always specify files explicitly
3. **ğŸ ALWAYS activate venv first** - `source .venv/bin/activate`
4. **ğŸ§ª ALWAYS run tests before committing** - `uv run pytest`
5. **ğŸ“ ALWAYS explain changes** - What/Why/How/Impact/Testing format
6. **ğŸš€ ALWAYS use GitHub Actions for deployment** - Never deploy manually
7. **ğŸŒ¿ ALWAYS use feature branches** - Never commit directly to main
8. **ğŸ”„ ALWAYS create pull requests** - All changes go through PR review
9. **âš« ALWAYS format with black** - `uv run black .` before commits
10. **ğŸ” ALWAYS type check** - `uv run mypy . --strict` must pass

## Project: Instagram Unfurl Service for Slack

### Overview
Serverless Instagram link unfurler that generates rich previews in Slack channels using advanced scraping strategies with intelligent fallbacks.

### Architecture
```yaml
Type: Container-based Lambda (ARM64)
Flow: API Gateway â†’ SNS â†’ Lambda processors
Storage: DynamoDB (caching) + S3 (static assets)
Observability: Logfire (logs/traces/metrics) + CloudWatch
Deployment: AWS CDK + GitHub Actions CI/CD
```

### Tech Stack
```yaml
Language: Python 3.12.3
Package Manager: UV (ultra-fast, replaces pip/venv)
Infrastructure: AWS CDK (TypeScript/Python)
Container: Docker with multi-stage builds
Browser Automation: Playwright (headless Chromium)
Testing: pytest with 80%+ coverage requirement
Code Quality: black + flake8 + mypy (strict mode)
```

## ğŸ—ï¸ Architecture Constraints (IMMUTABLE)

### Fixed Lambda Handler Locations
```
src/event_router/handler.py          # API Gateway â†’ SNS (< 3s response)
src/unfurl_processor/handler_new.py  # Container-based async processor
src/unfurl_processor/entrypoint.py   # Container initialization
```
**These paths are hardcoded in CDK - DO NOT MOVE**

### Component Dependencies (One Direction Only)
```
Scrapers â† Handler â† Infrastructure â† CDK
(Core)     (Async)   (AWS/Slack)     (Deploy)
```

### Quick Validation
```bash
pwd                    # Should be in project root
which python           # Should show .venv/bin/python
echo $VIRTUAL_ENV      # Should show .venv path
git branch             # Should NOT be on main
docker --version       # Should have Docker running
```

## ğŸ”„ Common Workflows

### Starting ANY Work
```bash
cd unfurl-service
source .venv/bin/activate
uv pip install -e .
git pull origin main
git checkout -b feature/your-feature  # NEVER work on main
```

### Before ANY Commit
```bash
# Explain what you're about to commit
echo "Changes: [describe what you're committing]"

# Run quality checks
uv run black .
uv run flake8 .
uv run mypy . --strict
uv run pytest

# Add specific files only
git add src/specific/file.py tests/specific/test_file.py

# Commit with conventional message
git commit -m "type(scope): description"
```

### Creating a Pull Request
```bash
# Push feature branch
git push origin feature/your-feature

# Create PR (never merge locally)
gh pr create --title "type: description" --body "Details of changes"

# Let GitHub Actions handle deployment - NEVER deploy manually
```

### Quick Quality Check
```bash
uv run black . && \
uv run flake8 . && \
uv run mypy . --strict && \
uv run pytest --cov=src
```

## ğŸ¯ Current Focus Tracking

When working on a feature, maintain context:
```python
# CURRENT TASK: [Describe current work]
# STATUS: [Current progress]
# NEXT: [Next step]
# BLOCKERS: [Any issues]
```

## ğŸš¦ Go/No-Go Checklist

Before implementing ANYTHING:
- [ ] Is virtual environment active?
- [ ] Am I on a feature branch (not main)?
- [ ] Have I pulled latest changes?
- [ ] Do I understand the scraping strategy?
- [ ] Have I checked existing tests?
- [ ] Have I explained what I'm about to do?
- [ ] Is Docker running (for container tests)?

## Development Standards

### Code Quality Requirements

Before ANY commit, ALL must pass:
1. **Format**: `uv run black .`
2. **Lint**: `uv run flake8 .`
3. **Type Check**: `uv run mypy . --strict`
4. **Test**: `uv run pytest --cov=src`
5. **Explanation**: Document What/Why/How/Impact/Testing

### UV Package Management
```bash
# Virtual environment
uv venv                          # Create venv
source .venv/bin/activate        # Activate (Linux/Mac)

# Dependencies
uv pip install -e .              # Install project editable
uv pip install -r requirements-docker.txt  # Container deps
uv add package_name              # Add new package
uv run <command>                 # Run in venv context
```

### Scraping Strategy (Priority Order)
```yaml
1. Playwright Browser:
   - Path: src/unfurl_processor/scrapers/playwright_scraper.py
   - Stealth techniques, human-like behavior
   - Success rate: ~90%

2. Enhanced HTTP:
   - Path: src/unfurl_processor/scrapers/http_scraper.py
   - Session management, header rotation
   - Success rate: ~60%

3. oEmbed API:
   - Path: src/unfurl_processor/scrapers/oembed_scraper.py
   - Instagram Graph API fallback
   - Success rate: ~30%

4. Minimal Fallback:
   - Basic URL metadata
   - Always succeeds (graceful degradation)
```

## Key Files & Patterns

### Lambda Handlers
```yaml
Event Router (ZIP):
  - src/event_router/handler.py
  - Receives Slack events, publishes to SNS
  - Lightweight, fast response

Unfurl Processor (Container):
  - src/unfurl_processor/handler_new.py
  - Async processing with scrapers
  - src/unfurl_processor/entrypoint.py (container init)
```

### Infrastructure
```yaml
CDK Stack: cdk/stacks/unfurl_service_stack.py
Configuration: cdk.json
Docker: Dockerfile (multi-stage, Playwright deps)
```

### Testing
```yaml
Test Files: tests/test_*.py
Coverage: Minimum 80% required
Run: uv run pytest -v --cov=src
```

## Deployment

### GitHub Actions (Automatic)
```bash
# Push to main triggers deployment
git add . && git commit -m "feat: description" && git push
```

### Manual CDK Deployment
```bash
# Deploy all stacks
cdk deploy --all

# Deploy specific stack
cdk deploy UnfurlServiceStack
```

### Local Testing
```bash
# Validate environment
./scripts/validate_environment.py

# Test Docker build
./scripts/test_docker_build.sh

# Run tests with coverage
uv run pytest --cov=src --cov-report=html
```

## Environment Variables
```yaml
Required:
  SLACK_BOT_TOKEN: Bot user OAuth token (from Secrets Manager)
  SLACK_APP_TOKEN: App-level token (if using socket mode)
  DYNAMODB_TABLE_NAME: Cache table name
  SNS_TOPIC_ARN: Topic for async processing

Optional:
  LOG_LEVEL: INFO|DEBUG|WARNING|ERROR (default: INFO)
  LOGFIRE_TOKEN: Observability token
  LOGFIRE_SERVICE_NAME: Service identifier
  PLAYWRIGHT_TIMEOUT: Browser timeout in ms (default: 30000)
```

## Current Branch & Recent Work
```yaml
Branch: chore/issue-28-remove-legacy-handler-and-compression-deps
Recent:
  - #28: Removed legacy sync handler and compression dependencies
  - #27: Fixed Logfire logging handler integration
  - #26: Bundled observability module for event router
Status: Clean working tree, ready for new features
```

## Common Commands

### Development
```bash
# Setup
uv venv && source .venv/bin/activate
uv pip install -e .
python -m playwright install chromium

# Quality checks
uv run black .
uv run flake8 .
uv run mypy . --strict
uv run pytest

# Local testing
./scripts/test_docker_build.sh
uv run python -m unfurl_processor.handler_new  # Test handler
```

### Debugging
```bash
# Check Slack configuration
uv run python scripts/check-slack-config.py

# Validate environment
./scripts/validate_environment.py

# View CloudWatch logs
aws logs tail /aws/lambda/unfurl-processor --follow
```

## Performance Targets
```yaml
Cold Start: 3-5 seconds (container init + Playwright)
Warm Start: 100-500ms (cached browser instance)
Success Rate: 95%+ (with all fallback strategies)
Memory: 512-1024MB typical usage
Timeout: 30 seconds max execution
```

## Security Notes
```yaml
- Never commit secrets (use AWS Secrets Manager)
- Respect rate limits (Instagram: ~200 req/hour)
- User agent rotation for bot evasion
- IAM roles with least privilege
- Container runs as non-root user
```

## ğŸ” Architecture Quick Reference

```text
src/
â”œâ”€â”€ event_router/         # Receives Slack events (ZIP Lambda)
â”œâ”€â”€ unfurl_processor/     # Container Lambda with scrapers
â”‚   â”œâ”€â”€ scrapers/        # Modular scraping strategies
â”‚   â”‚   â”œâ”€â”€ manager.py   # Orchestration & fallback logic
â”‚   â”‚   â”œâ”€â”€ playwright_scraper.py  # Browser automation
â”‚   â”‚   â”œâ”€â”€ http_scraper.py        # Session-based HTTP
â”‚   â”‚   â””â”€â”€ oembed_scraper.py      # API fallback
â”‚   â”œâ”€â”€ handler_new.py   # Async Lambda handler
â”‚   â””â”€â”€ entrypoint.py    # Container initialization
â””â”€â”€ observability/        # Logfire integration
```

**Red Flags:**

- Hardcoded credentials anywhere
- Direct `os.environ` access outside config
- Synchronous code in async handlers
- Missing error handling in scrapers
- Working directly on main branch
- Manual CDK deployments when CI exists
- Tests that don't test actual behavior

## ğŸ†˜ When Stuck

1. Check: Am I on a feature branch?
2. Check: Is venv active?
3. Check: Is Docker running?
4. Check: Did I run quality checks?
5. Check: Are my changes explained?
6. Check: Do tests cover my changes?

If still stuck: Review logs in CloudWatch/Logfire

## ğŸ“ Memory Aid

**U.N.F.U.R.L.**
- **U**V package manager activated
- **N**ever commit to main directly
- **F**ormat with black always
- **U**nit tests must pass
- **R**eview PR before merge
- **L**ogfire for observability

## Code Change Protocol

Every modification MUST include:
1. **What**: Exact changes made
2. **Why**: Business/technical reasoning
3. **How**: Implementation approach
4. **Impact**: Performance/security/UX effects
5. **Testing**: Validation performed

## Quick Reference

```yaml
Scraper Manager: src/unfurl_processor/scrapers/manager.py:ScraperManager
Slack Formatter: src/unfurl_processor/slack_formatter.py:format_unfurl()
Container Handler: src/unfurl_processor/handler_new.py:lambda_handler()
Event Router: src/event_router/handler.py:lambda_handler()
CDK Stack: cdk/stacks/unfurl_service_stack.py:UnfurlServiceStack
```

---
*Remember: This document contains essential rules for the Unfurl Service. Always follow the CRITICAL RULES and use feature branches for all development work.*